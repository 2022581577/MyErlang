#! /bin/bash
ROOT=`cd $(dirname $0); pwd`
CONFDIR=$ROOT/config

# å®šä¹‰erlang vmé€‰é¡¹
ERL=/usr/local/bin/erl
POLL=true
ASYNC=8
SMP=true
ERL_PROCESSES=500000
CONNECT_ALL=true
DATETIME=`date "+%Y%m%d-%H%M%S"`
export ERL_CRASH_DUMP=$ROOT/erl_crash_$DATETIME.dump
export ERL_MAX_PORTS=102400
export ERL_MAX_ETS_TABLES=10000
export HOME=$ROOT
SYSTEM_CONF_FILE=$CONFDIR/system.config
GAME_CONF_FILE=$CONFDIR/game.config

# è¿è¡Œçš„ç¨‹åºåŠæ§åˆ¶æ–‡ä»¶
APP_MOD=main
APP_CTL=game_ctl
# define additional environment variables
EBINS="$ROOT/ebin"

SERVER_NAME=""              # æ§åˆ¶èŠ‚ç‚¹å
CONFIG_PATH="default"       # é…ç½®æ–‡ä»¶è·¯å¾„
SYNC_CONFIG_PATH="default"     # éœ€åŒæ­¥é…ç½®æ–‡ä»¶è·¯å¾„
CODE_PATH="default"            # ä»£ç è·¯å¾„
EXTRA_ARGS="erlang_beam"       # å¤–éƒ¨å‚æ•°
SERVER_IP="127.0.0.1"          # æœåŠ¡å™¨IP
SERVER_PORT="0"                # æœåŠ¡å™¨ç«¯å£
SERVER_VERSION="default"       # æœåŠ¡ç«¯ç‰ˆæœ¬å·
CLIENT_VERSION="default"       # å‰ç«¯ç‰ˆæœ¬å·
UPDATE_VERSION="default"       # æ›´æ–°ç‰ˆæœ¬
CREATE_DB="false"              # æ˜¯å¦æ–°å»ºDB

STATUS_SUCCESS=0    # æˆåŠŸ
STATUS_NORUN=1      # æœªè¿è¡Œ
STATUS_USAGE=2      # ä½¿ç”¨é”™è¯¯
STATUS_BADRPC=3     # rpcè°ƒç”¨é”™è¯¯
STATUS_ERROR=4      # å…¶å®ƒé”™è¯¯
STATUS_STARTING=5   # æ­£åœ¨å¼€æœä¸­
STATUS_RUNNING=6    # è¿è¡Œä¸­
STATUS_STOPING=7    # æ­£åœ¨å…³æœä¸­

CTL_STATUS_NORUN=0
CTL_STATUS_STARTING=1
CTL_STATUS_RUNNING=2
CTL_STATUS_STOPING=3
CTL_STATUS_ERROR=4

# å¼€æœå¤±è´¥ä¿¡æ¯
START_ERROR_CONFIG=1
START_ERROR_CODE_PATH=2
START_ERROR_CONN_FAIL=3
START_ERROR_STATE=4
START_ERROR_MISS_INFO=5

# é‡æ–°åŠ è½½çš„ç³»ç»Ÿæ•°æ®
RELOAD_TYPE=code

# æ‰“å°é”™è¯¯
error() {
    echo -e "[1;41m[é”™è¯¯][`date +"%F %T"`][0m ${SERVER_ID}æœ[${ERLANG_NODE}]$1"
    exit 1
}

# æ‰“å°ä¿¡æ¯
echo2() {
    echo -e "[1;42m[æ“ä½œ][`date +"%F %T"`][0m ${SERVER_ID}æœ[${ERLANG_NODE}]$1"
}

# æ‰“å°ä¿¡æ¯(ä¸æ¢è¡Œ)
echo2_n() {
    echo -n -e "[1;42m[æ“ä½œ][`date +"%F %T"`][0m ${SERVER_ID}æœ[${ERLANG_NODE}]$1"
}

# æ‰“å°è­¦å‘Š
warn() {
    echo -e "[1;43m[è­¦å‘Š][`date +"%F %T"`][0m ${SERVER_ID}æœ[${ERLANG_NODE}]$1"
}

# è·å–å†…ç½‘ip
getip() {
    echo `LANG=en_US; ifconfig | grep 'inet addr:' | grep -v '127.0.0.1' | grep '192.*' | cut -d: -f 2 | awk '{print $1}'`
}

# ä½¿ç”¨è¯´æ˜
usage ()
{
    echo ""
    echo "ç”¨æ³•:"
    echo "$0 ACTION [OPTION]"
    echo "ACTION:"
    echo "  live            äº¤äº’æ–¹å¼å¯åŠ¨"
    echo "  start           åå°æ–¹å¼å¯åŠ¨"
    echo "  async_start     åå°æ–¹å¼å¯åŠ¨(å¼‚æ­¥)" 
    echo "  status          è·å–åå°è¿è¡ŒçŠ¶æ€"
    echo "  attach          é€šè¿‡Erlang shellè¿æ¥åå°è¿è¡ŒèŠ‚ç‚¹"
    echo "  stop            ç«‹å³åœæ­¢èŠ‚ç‚¹(åŒæ­¥)"
    echo "  restart         é‡å¯èŠ‚ç‚¹"
    echo "  reload          é‡æ–°åŠ è½½æ•°æ®æˆ–ä»£ç "
    echo "  count           è·å–åœ¨çº¿äººæ•°"
    echo "  version         è·å–ç‰ˆæœ¬ä¿¡æ¯"
    echo "  switch_db       åˆ‡æ¢æ¸¸æˆæœæ•°æ®"
    echo "  check_db        æ£€æŸ¥æ¸¸æˆæœæ•°æ®çŠ¶æ€"
    echo "  start_server    å¼€å¯æœåŠ¡å™¨"
    echo "  batch_start     æŒ‡é‡å¼€å¯æœåŠ¡å™¨"
    echo "  stop_server     å…³é—­æœåŠ¡å™¨"
    echo "  remove_server   ç§»é™¤æœåŠ¡èŠ‚ç‚¹"
    echo "  check_server    æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€"
    echo "  rpc_switch_db   åˆ‡æ¢æ•°æ®åº“"
    echo "  rpc_check_db    æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€"
    echo "  rpc_switch_version   åˆ‡æ¢ç‰ˆæœ¬,æ›´æ–°ç”¨"
    echo "  rpc_check_version    æŸ¥æ‰¾ç‰ˆæœ¬ä¿¡æ¯"
    echo "  rpc_check_update     æ£€æŸ¥æ›´æ–°"
    echo "  list_server     æŸ¥çœ‹åˆ—å‡ºæœåŠ¡å™¨ä¿¡æ¯"
    echo "  list_node       æŸ¥çœ‹åˆ—å‡ºèŠ‚ç‚¹ä¿¡æ¯"
    echo "  list_version    æŸ¥çœ‹åˆ—å‡ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  rpc_count       æŸ¥çœ‹åœ¨çº¿ç©å®¶ä¿¡æ¯"
    echo "  list_db         æŸ¥çœ‹åˆ—å‡ºæ•°æ®åº“è¿æ¥ä¿¡æ¯"
    echo "  list_update     æŸ¥çœ‹åˆ—å‡ºæ›´æ–°ä¿¡æ¯"
    echo "  check_data      æ£€æŸ¥ç­–åˆ’dataæ•°æ®"
    echo "  check_data_log  è·å–æœ€æ–°çš„ç­–åˆ’dataæ•°æ®æ£€æµ‹æ—¥å¿—æ–‡ä»¶å"
    echo ""
    echo "OPTION:"
    echo "  -h, --help              æ˜¾ç¤ºæœ¬ä¿¡æ¯"
    echo "  -s, --smp=true          æ˜¯å¦ä½¿ç”¨smp(true|false,é»˜è®¤ä¸ºtrue)"
    echo "  -c, --cookie=Cookie     èŠ‚ç‚¹cookie(é»˜è®¤\"\")"
    echo "  -f, --conf=Conf         æŒ‡æ˜ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(é»˜è®¤game.conf)"
    echo "  -r, --reload=Type       æŒ‡æ˜è¦reloadçš„ç³»ç»Ÿæ•°æ®:code,configæˆ–è€…æŒ‡å®šæ¨¡å—åç§°"
    echo "  -n, --name=Name         æŒ‡æ˜è¦ç®¡ç†çš„æœåŠ¡å™¨åç§°"
    echo "  --config=ConfigFile     æŒ‡æ˜æœåŠ¡å™¨éœ€è¦é…ç½®ç›®å½•è·¯å¾„"
    echo "  --sync_config=CodeFile  æŒ‡æ˜åŒæ­¥é…ç½®æ–‡ä»¶ï¼Œè¿œç¨‹æ§åˆ¶æ—¶ç”¨"
    echo "  --code=CodePath         æŒ‡æ˜beamæ–‡ä»¶æ‰€åœ¨ç›®å½•"
    echo "  --server_version=V      æŒ‡æ˜æœåŠ¡ç«¯ç‰ˆæœ¬"
    echo "  --client_version=V      æŒ‡æ˜å‰ç«¯ç‰ˆæœ¬"
    echo ""
}

# ä¿®æ”¹ulimit
change_ulimit() {
    if ! ulimit -HSn 102400 2> /dev/null ; then
        ## error "è¯·ç¡®ä¿å…·æœ‰rootæƒé™"
        echo "è¯·ç¡®ä¿å…·æœ‰rootæƒé™"
    fi
}

# æŸ¥è¯¢è¿è¡Œä¸­èŠ‚ç‚¹çš„ä¿¡æ¯
rpc() 
{
    $ERL \
      $NAME_FLAG ${CTL_NAME}_ctl@$HOST \
      -noinput \
      -pa $EBINS \
	  -config $SYSTEM_CONF_FILE \
      -setcookie ${COOKIE} \
      -s ${APP_CTL} -extra $ERLANG_NODE $@
}

# æ‰“å°rpcè¿”å›ä¿¡æ¯
print_rpc_return ()
{
    case $1 in
    $STATUS_SUCCESS) 
        echo ""
        ;;
    $STATUS_NORUN) 
        warn "æœªè¿è¡Œ!"
        ;;
    $STATUS_USAGE) 
        error "å‘½ä»¤ä¸æ”¯æŒ! $0 -hæŸ¥çœ‹å¸®åŠ©"
        ;;
    $STATUS_BADRPC) 
        error "RPCå‘ç”Ÿé”™è¯¯"
        ;;
    $STATUS_ERROR) 
        error "è¯·æ±‚å‘ç”Ÿé”™è¯¯"
        ;;
    $STATUS_STARTING) 
        echo2 "æ­£åœ¨å¼€æœä¸­"
        ;;
    $STATUS_RUNNING) 
        echo2 "è¿è¡Œä¸­"
        ;;
    $STATUS_STOPING) 
        echo2 "æ­£åœ¨åœæœä¸­"
        ;;
    *)
        error "æœªçŸ¥å‘½ä»¤! $0 -hæŸ¥çœ‹å¸®åŠ©"
    esac
    exit $1
}

# æŸ¥çœ‹dataæ•°æ®æ£€æµ‹æ—¥å¿—æ–‡ä»¶
check_data_log ()
{
    CHECKLOGDIR=$LOGDIR/check_data
    FILE=$(find $CHECKLOGDIR -maxdepth 1 | sort -r | head -n 1)
    echo "æœ€æ–°dataæ•°æ®æ£€æµ‹æ—¥å¿—æ–‡ä»¶å:$FILE"
}

# æ£€æµ‹dataæ•°æ®
check_data ()
{
    if is_data_ok; then
        echo "ç­–åˆ’dataæ•°æ®å­˜åœ¨é—®é¢˜"
        check_data_log
        return 1
    fi
    echo "ç­–åˆ’dataæ•°æ®ok!"
    check_data_log
}

is_data_ok ()
{   
    if [ "$SERVER_TYPE" = "game" ]; then
        result=$?
        $ERL \
        -pa $EBINS \
        -noinput \
        -kernel error_logger silent \
        -eval "check_data:start()."
        result=$?
        if [ $result = 0 ]; then
            return 1
        fi
        return 0
    fi
    return 1
}

# åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
is_started () 
{
    rpc status
    result=$?
    if [  "$result" = "$STATUS_RUNNING" ]; then
        return 0
    fi
    return $result
}

# åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦crash
is_crashed() 
{
    if [ -f ${ERL_CRASH_DUMP} ]; then
        return 0
    fi
    return 1
}

# start interactive server
live ()
{
    change_ulimit
    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -pa $EBINS \
	  -config $SYSTEM_CONF_FILE \
      -setcookie ${COOKIE} \
      -s ${APP_MOD} start \
      $ERLANG_OPTS --extra $ARGS "$@"
}

# å¯åŠ¨server
start ()
{
    change_ulimit
    ensure_log_dir
    if is_started; then
        warn "èŠ‚ç‚¹$ERLANG_NODEå·²ç»å¯åŠ¨"
        exit 0
    fi
    #if is_data_ok; then
    #    warn "ç­–åˆ’dataæ•°æ®æœ‰é—®é¢˜"
    #    exit 0
    #fi
    echo2_n "å¼€å§‹å¯åŠ¨" 
    # ç­‰å¾…1ç§’é’Ÿ
    sleep 1
    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -noinput -detached \
      -hidden \
      -pa $EBINS \
      -setcookie ${COOKIE} \
      -kernel error_logger silent \
      -sasl sasl_error_logger \{file,\"$SASL_LOG\"\} \
      -kernel inet_dist_listen_min 10000 inet_dist_listen_max 20000 \
      -s ${APP_MOD} start\
      $ERLANG_OPTS $ARGS "$@"
    
    if [ "$1" = "async" ]; then
        echo ""
        echo2 "å¯åŠ¨ä¸­ï¼Œè¯·ç¨å€™é€šè¿‡$0 statusæ£€æµ‹"
        exit 0
    fi

    RETRY=0
    while true; do
        if [ $? -ne 0 ]; then
            echo ""
            error "å¯åŠ¨å¤±è´¥:$?"
        else
            if is_started; then
                break
            fi
            if is_crashed; then
                echo ""
                error "å¯åŠ¨å¤±è´¥,å‘ç”Ÿcrash!"
            else
                let RETRY++
                echo -n "."
                sleep 1
            fi
        fi
    done
    echo ""
    echo2 "å¯åŠ¨æˆåŠŸ"
}

# è·å–çŠ¶æ€
status ()
{
    if is_started; then
        echo2 "è¿è¡Œä¸­"
    else
        print_rpc_return $?
    fi  
}

# è¿æ¥åˆ°èŠ‚ç‚¹å†…
attach ()
{
    if ! is_started; then
        error "${SERVER_ID}æœ[$ERLANG_NODE]æœªå¯åŠ¨"
    fi
    $ERL \
      $NAME_FLAG ${NAME}_attach@$HOST \
      -setcookie ${COOKIE} \
      -remsh $ERLANG_NODE \
      $ERLANG_OPTS $ARGS "$@"
}

# åœæ­¢èŠ‚ç‚¹
stop ()
{
    if rpc stop $@; then
        echo2 "åœæ­¢"
    else
        print_rpc_return $?
    fi  
}

# é‡å¯èŠ‚ç‚¹
restart ()
{
    if rpc restart; then
        echo2 "é‡å¯æˆåŠŸ"
    else
        print_rpc_return $?
    fi  
}

# é‡æ–°åŠ è½½
reload ()
{
    if rpc reload ${RELOAD_TYPE}; then
        echo2 "é‡æ–°åŠ è½½${RELOAD_TYPE}æˆåŠŸ"
    else
        error "é‡æ–°åŠ è½½${RELOAD_TYPE}å¤±è´¥"
    fi  
}

# è·å–åœ¨çº¿äººæ•°
count ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    rpc count
}


# è·å–ç‰ˆæœ¬ä¿¡æ¯
version ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    rpc version
}

# åˆ‡æ¢æ•°åº“
switch_db ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    if rpc switch_db;then
        echo2 "åˆ‡æ¢æ•°æ®åº“æˆåŠŸ"
    else
        error "åˆ‡æ¢æ•°æ®å¤±è´¥"
    fi
}

# åˆ‡æ¢ç‰ˆæœ¬
rpc_switch_version ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    if rpc rpc_switch_version $SERVER_IP $SERVER_PORT $SERVER_NAME $SERVER_VERSION $CLIENT_VERSION;then
        echo2 "åˆ‡æ¢ç‰ˆæœ¬æˆåŠŸ"
    else
        error "åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥"
    fi
}

# æ•°æ®åº“çŠ¶æ€
rpc_check_version ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    if rpc rpc_check_version $SERVER_IP $SERVER_PORT $SERVER_NAME $SERVER_VERSION $CLIENT_VERSION;then
        echo2 "ç‰ˆæœ¬æ£€æŸ¥æˆåŠŸ"
    else
        error "ç‰ˆæœ¬ä¸æ­£ç¡®"
    fi

}

# æ•°æ®åº“çŠ¶æ€
check_db ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    if rpc check_db;then
        echo2 "æ•°æ®åº“è¿æ¥æˆåŠŸ"
    else
        error "æ•°æ®è¿æ¥å¤±è´¥"
    fi
}



# å¼€å¯æœåŠ¡èŠ‚ç‚¹
start_server()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi

    rpc start_server $SERVER_IP $SERVER_PORT $SERVER_NAME $CONFIG_PATH $SYNC_CONFIG_PATH $CODE_PATH $SERVER_VERSION $CLIENT_VERSION $CREATE_DB $EXTRA_ARGS
    result=$?
    if [  "$result" = "$STATUS_SUCCESS" ]; then
        echo2 "æŒ‡ä»¤å‘é€æˆåŠŸ"
    elif [  "$result" = "$START_ERROR_CONFIG" ]; then
        echo2 "å¤±è´¥ï¼Œé…ç½®æ£€æŸ¥å‡ºé”™"
    elif [  "$result" = "$START_ERROR_CODE_PATH" ]; then
        echo2 "å¤±è´¥ï¼Œä»£ç è·¯å¾„ä¸æ­£ç¡®"
    elif [  "$result" = "$START_ERROR_CONN_FAIL" ]; then
        echo2 "å¤±è´¥ï¼Œç›®æ ‡managerè¿æ¥å¤±è´¥"
    elif [  "$result" = "$START_ERROR_STATE" ]; then
        echo2 "å¤±è´¥ï¼Œæ¸¸æˆæœä¸ºéå…³é—­çŠ¶æ€"
    elif [  "$result" = "$START_ERROR_CONFIG" ]; then
        echo2 "å¤±è´¥ï¼Œæ¸¸æˆæœä¸ºéå…³é—­çŠ¶æ€"
    else
        echo2 "æœåŠ¡[${SERVER_NAME}]é”™è¯¯"
    fi
    exit $result
}

# å¼€å¯æœåŠ¡èŠ‚ç‚¹
batch_start()
{
    if [ -z "$SERVER_NAME" ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi

    rpc batch_start $SERVER_IP $SERVER_PORT $CONFIG_PATH $CODE_PATH $SERVER_VERSION $CLIENT_VERSION $CREATE_DB $SERVER_NAME
    result=$?
    if [  "$result" = "$STATUS_SUCCESS" ]; then
        echo2 "æŒ‡ä»¤å‘é€æˆåŠŸ"
    elif [  "$result" = "$START_ERROR_CONFIG" ]; then
        echo2 "å¤±è´¥ï¼Œé…ç½®æ£€æŸ¥å‡ºé”™"
    elif [  "$result" = "$START_ERROR_CODE_PATH" ]; then
        echo2 "å¤±è´¥ï¼Œä»£ç è·¯å¾„ä¸æ­£ç¡®"
    elif [  "$result" = "$START_ERROR_CONN_FAIL" ]; then
        echo2 "å¤±è´¥ï¼Œç›®æ ‡managerè¿æ¥å¤±è´¥"
    elif [  "$result" = "$START_ERROR_STATE" ]; then
        echo2 "å¤±è´¥ï¼Œæ¸¸æˆæœä¸ºéå…³é—­çŠ¶æ€"
    elif [  "$result" = "$START_ERROR_CONFIG" ]; then
        echo2 "å¤±è´¥ï¼Œæ¸¸æˆæœä¸ºéå…³é—­çŠ¶æ€"
    else
        echo2 "æœåŠ¡[${SERVER_NAME}]é”™è¯¯"
    fi
    exit $result
}



# åœæ­¢æœåŠ¡èŠ‚ç‚¹
stop_server ()
{
    if [ -z "$SERVER_NAME" ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    
    if rpc stop_server $SERVER_IP $SERVER_PORT $SERVER_NAME; then
        echo2 "å…³é—­æœåŠ¡[${SERVER_NAME}]æŒ‡ä»¤å‘é€æˆåŠŸ"
        exit 0
    else
        error "å…³é—­æœåŠ¡[${SERVER_NAME}]æŒ‡ä»¤å‘é€å¤±è´¥"
    fi
}

# ç§»é™¤æœåŠ¡èŠ‚ç‚¹
remove_server ()
{
    if [ -z "$SERVER_NAME" ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    
    if rpc remove_server $SERVER_IP $SERVER_PORT $SERVER_NAME; then
        echo2 "ç§»é™¤æœåŠ¡[${SERVER_NAME}]æŒ‡ä»¤å‘é€æˆåŠŸ"
        exit 0
    else
        error "ç§»é™¤æœåŠ¡[${SERVER_NAME}]æŒ‡ä»¤å‘é€å¤±è´¥,æœåŠ¡æœªå…³é—­"
    fi
}


# åˆ‡æ¢æ•°åº“
rpc_switch_db ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    if rpc rpc_switch_db $SERVER_IP $SERVER_PORT $SERVER_NAME $CONFIG_PATH $SYNC_CONFIG_PATH ;then
        echo2 "åˆ‡æ¢æ•°æ®åº“æˆåŠŸ"
        exit 0
    else
        error "åˆ‡æ¢æ•°æ®åº“å¤±è´¥"
    fi
}

# æ•°æ®åº“çŠ¶æ€
rpc_check_db ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    if rpc rpc_check_db $SERVER_IP $SERVER_PORT $SERVER_NAME;then
        echo2 "æ•°æ®åº“è¿æ¥æˆåŠŸ"
    else
        error "æ•°æ®è¿æ¥å¤±è´¥"
    fi
}

# æ£€æŸ¥æ›´æ–°
rpc_check_update ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    if rpc rpc_check_update $SERVER_IP $SERVER_PORT $SERVER_NAME $UPDATE_VERSION;then
        echo2 "æ£€æŸ¥æ›´æ–°æˆåŠŸ"
    else
        error "æ£€æŸ¥æ›´æ–°å¤±è´¥"
    fi
}

list_update() 
{
    rpc list_update $SERVER_IP $SERVER_PORT
}

# é‡æ–°åŠ è½½é…ç½®
reload_config ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
    if rpc reload_config $SERVER_IP $SERVER_PORT $SERVER_NAME $CONFIG_PATH $SYNC_CONFIG_PATH;then
        echo2 "é‡æ–°åŠ è½½é…ç½®æˆåŠŸ"
    else
        error "é‡æ–°åŠ è½½é…ç½®å¤±è´¥"
    fi
}

# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
check_server ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
   
    rpc check_server $SERVER_IP $SERVER_PORT $SERVER_NAME
    result=$?
    if [  "$result" = "$CTL_STATUS_RUNNING" ]; then
        echo2 "æœåŠ¡[${SERVER_NAME}]è¿è¡Œä¸­"
    elif [  "$result" = "$CTL_STATUS_STARTING" ]; then
        echo2 "æœåŠ¡[${SERVER_NAME}]æ­£åœ¨å¼€å¯"
    elif [  "$result" = "$CTL_STATUS_STOPING" ]; then
        echo2 "æœåŠ¡[${SERVER_NAME}]æ­£åœ¨åœæ­¢"
    elif [  "$result" = "$CTL_STATUS_NORUN" ]; then
        echo2 "æœåŠ¡[${SERVER_NAME}]æœªè¿è¡Œ"
    else
        echo2 "æœåŠ¡[${SERVER_NAME}]é”™è¯¯"
    fi
    return $result
}

list_server ()
{
    rpc list_server $SERVER_IP $SERVER_PORT
}

list_node ()
{
    rpc list_node $SERVER_IP $SERVER_PORT
}

list_version ()
{
    rpc list_version $SERVER_IP $SERVER_PORT
}

rpc_count ()
{
    if [ -z $SERVER_NAME ]; then
        error "æœåŠ¡å™¨èŠ‚ç‚¹åç§°æœªæŒ‡å®š"
    fi
   
    rpc rpc_count $SERVER_IP $SERVER_PORT $SERVER_NAME
}

list_db ()
{
    rpc list_db $SERVER_IP $SERVER_PORT
}


# parse command line parameters
while [ $# -ne 0 ] ; do
    PARAM=$1
    shift
    case $PARAM in
        --) break ;;
        --cookie|-c) COOKIE=$1 ; shift ;;
        --conf|-f) 
            #GAME_CONF_FILE=$CONFDIR/${1##*/};
            GAME_CONF_FILE=$1;
            export GAME_CONF_FILE=${GAME_CONF_FILE}; 
            shift ;;
        --help|-h) usage; exit 0;;
        --smp|-s) SMP=$1; shift;;
        --reload|-r) RELOAD_TYPE=$@; break;;
        --name|-n) SERVER_NAME=$1 ; shift ;;
        --code) CODE_PATH=$1 ; shift ;;
        --config) CONFIG_PATH=$1 ; shift ;;
        --sync_config) SYNC_CONFIG_PATH=$1 ; shift ;;
        --server_version) SERVER_VERSION=$1 ; shift ;;
        --update_version) UPDATE_VERSION=$1 ; shift ;;
        --client_version) CLIENT_VERSION=$1 ; shift ;;
        --create_db) CREATE_DB=$1 ; shift ;;
        --extra_args) EXTRA_ARGS=$1 ; shift ;;
        --ip) SERVER_IP=$1 ; shift ;;
        --port) SERVER_PORT=$1 ; shift ;;
        *) ARGS="$ARGS $PARAM" ;;
    esac
done

# è·å–server_id
SERVER_TYPE=`cat ${GAME_CONF_FILE}  | grep -ri 'server_type' | sed -e 's/{server_type,\s*\(.*\)}.*/\1/'`
SERVER_ID=`cat ${GAME_CONF_FILE}  | grep -ri 'server_id' | sed -e 's/{server_id,\s*\(.*\)}.*/\1/'`
PLATFORM_ID=`cat ${GAME_CONF_FILE}  | grep -ri 'platform' | sed -e 's/{platform,\s*\"\(.*\)\"}.*/\1/'`
SERVER_PREFIX=`cat ${GAME_CONF_FILE}  | grep -ri 'prefix' | sed -e 's/{prefix,\s*\(.*\)}.*/\1/'`
if [ "$SERVER_PREFIX" = "" ]; then
    SERVER_PREFIX="s"
fi
SERVER_ID=${PLATFORM_ID}_${SERVER_PREFIX}${SERVER_ID}

# ä¿®æ”¹å¼•ç”¨ç›®å½•
if [ "$SERVER_TYPE" == "game" ] || [ "$SERVER_TYPE" == "merger" ] || [ "$SERVER_TYPE" == "across" ]; then
    EBINS="$ROOT/ebin $ROOT/deps/data_cn"
fi

# èŠ‚ç‚¹å
ERLANG_NODE=${SERVER_TYPE}_${SERVER_ID}@localhost
COOKIE="node-cookie"

NAME=${ERLANG_NODE%%@*}
HOST=${ERLANG_NODE##*@}
TIMESTAMP=`date "+%Y%m%d-%H%M%S_%N"`
CTL_NAME=${NAME}"_"${TIMESTAMP}
NAME_FLAG=-name
[ "$ERLANG_NODE" = "${ERLANG_NODE%.*}" ] && NAME_FLAG=-sname
LOCAL_IP=$(getip)
if [ "$NAME_FLAG" = "-name" -a "$HOST" !=  "$LOCAL_IP" ]; then 
    error "èŠ‚ç‚¹åç§°:$ERLANG_NODEä¸æœ¬æœºip:$LOCAL_IPä¸ç›¸ç¬¦"
fi

if [ "$SMP" = "false" ]; then
    SMP=disable
else
    SMP=enable
fi
ERLANG_OPTS="-connect_all $CONNECT_ALL +K $POLL -smp $SMP +P $ERL_PROCESSES \
    +t 10485760 +fnu +hms 8192 +hmbs 8192 +zdbbl 81920 -v"

# æ¸¸æˆç”Ÿæˆçš„ç›¸å…³æ–‡ä»¶è·¯å¾„
LOGDIR=$ROOT/data
# æ¸¸æˆé”™è¯¯æ—¥å¿—çš„è·¯å¾„
ERRLOGDIR=$LOGDIR/${SERVER_TYPE}_$SERVER_ID/logs
CHECKLOGDIR=$LOGDIR/${SERVER_TYPE}_$SERVER_ID/check_logs
# makesure the logs dir exists
ensure_log_dir()
{
    if [ ! -d $ERRLOGDIR ]; then
        mkdir -p $ERRLOGDIR || (echo "make $ERRLOGDIR error!"; exit 1)
    fi
    SASL_LOG=$ERRLOGDIR/game_${SERVER_ID}_${DATETIME}.sasl
    ERROR_LOG=$ERRLOGDIR/game_${SERVER_ID}_${DATETIME}.log
}


case $ARGS in
    '') usage;;
    ' live') live;;
    ' start') start sync;;
    ' async_start') start async;;
    ' status') status;;
    ' attach') attach;;
    ' stop') stop 0;;
    ' restart') restart;;
    ' count') count;;
    ' reload') reload;;
    ' version') version;;
    ' switch_db') switch_db;;
    ' check_db') check_db;;
    ' check_data') check_data;;
    ' start_server') start_server;;
    ' batch_start') batch_start;;
    ' stop_server') stop_server;;
    ' remove_server') remove_server;;
    ' check_server') check_server;;
    ' reload_config') reload_config;;
    ' rpc_switch_db') rpc_switch_db;;
    ' rpc_check_db') rpc_check_db;;
    ' rpc_switch_version') rpc_switch_version;;
    ' rpc_check_version') rpc_check_version;;
    ' rpc_check_update') rpc_check_update;;
    ' list_server') list_server;;
    ' list_node') list_node;;
    ' list_version') list_version;;
    ' rpc_count') rpc_count;;
    ' list_db') list_db;;
    ' list_update') list_update;;
    *) usage; exit 1
esac
